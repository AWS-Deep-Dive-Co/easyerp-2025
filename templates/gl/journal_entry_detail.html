{% extends 'base.html' %}
{% load static %}

{% block title %}Journal Entry {{ entry.entry_number }} - EasyERP{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Journal Entry {{ entry.entry_number }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'gl:entry_list' %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
            {% if not entry.is_posted %}
                <a href="{% url 'gl:entry_edit' entry.id %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-edit"></i> Edit
                </a>
                <a href="{% url 'gl:entry_post' entry.id %}" class="btn btn-sm btn-success">
                    <i class="fas fa-check"></i> Post Entry
                </a>
            {% endif %}
            <button onclick="window.print()" class="btn btn-sm btn-outline-info">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>
</div>

<!-- Entry Header Information -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Entry Information</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Entry Number:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ entry.entry_number }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Entry Date:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ entry.entry_date|date:"F j, Y" }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Reference:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ entry.reference|default:"-" }}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Status:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="badge 
                            {% if entry.is_posted %}badge-success
                            {% else %}badge-secondary
                            {% endif %}">
                            {% if entry.is_posted %}Posted{% else %}Draft{% endif %}
                        </span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Created By:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ entry.created_by.get_full_name|default:entry.created_by.username }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Created Date:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ entry.created_at|date:"F j, Y g:i A" }}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="row mb-3">
                    <div class="col-sm-2">
                        <strong>Description:</strong>
                    </div>
                    <div class="col-sm-10">
                        {{ entry.description }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Entry Lines -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Entry Lines</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th width="15%">Account Code</th>
                        <th width="25%">Account Name</th>
                        <th width="30%">Description</th>
                        <th width="15%" class="text-end">Debit</th>
                        <th width="15%" class="text-end">Credit</th>
                    </tr>
                </thead>
                <tbody>
                    {% if entry.lines.all %}
                        {% for line in entry.lines.all %}
                        <tr>
                            <td>{{ line.account.code }}</td>
                            <td>{{ line.account.name }}</td>
                            <td>{{ line.description }}</td>
                            <td class="text-end">
                                {% if line.debit_amount %}
                                    ${{ line.debit_amount|floatformat:2 }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if line.credit_amount %}
                                    ${{ line.credit_amount|floatformat:2 }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <!-- Sample data for demonstration -->
                        <tr>
                            <td>1000</td>
                            <td>Cash - Operating</td>
                            <td>Payment received from customer ABC Corp</td>
                            <td class="text-end">$1,500.00</td>
                            <td class="text-end">-</td>
                        </tr>
                        <tr>
                            <td>1100</td>
                            <td>Accounts Receivable</td>
                            <td>Invoice INV-2025-001 payment</td>
                            <td class="text-end">-</td>
                            <td class="text-end">$1,500.00</td>
                        </tr>
                    {% endif %}
                </tbody>
                <tfoot>
                    <tr class="table-info">
                        <th colspan="3">
                            <strong>Totals</strong>
                        </th>
                        <th class="text-end">
                            <strong>${{ entry.total_debit|floatformat:2 }}</strong>
                        </th>
                        <th class="text-end">
                            <strong>${{ entry.total_credit|floatformat:2 }}</strong>
                        </th>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        {% if entry.total_debit == entry.total_credit %}
            <div class="alert alert-success mt-3">
                <i class="fas fa-check-circle"></i>
                <strong>Balanced Entry:</strong> Total debits equal total credits.
            </div>
        {% else %}
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Unbalanced Entry:</strong> Total debits do not equal total credits.
                Difference: ${{ entry.balance_difference|floatformat:2|default:"0.00" }}
            </div>
        {% endif %}
    </div>
</div>

<!-- Audit Trail -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Audit Trail</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Date/Time</th>
                        <th>Action</th>
                        <th>User</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% if entry.audit_logs.all %}
                        {% for log in entry.audit_logs.all %}
                        <tr>
                            <td>{{ log.timestamp|date:"M j, Y g:i A" }}</td>
                            <td>
                                <span class="badge 
                                    {% if log.action == 'CREATED' %}badge-info
                                    {% elif log.action == 'MODIFIED' %}badge-warning
                                    {% elif log.action == 'POSTED' %}badge-success
                                    {% elif log.action == 'REVERSED' %}badge-danger
                                    {% endif %}">
                                    {{ log.get_action_display }}
                                </span>
                            </td>
                            <td>{{ log.user.get_full_name }}</td>
                            <td>{{ log.notes }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <!-- Sample audit data -->
                        <tr>
                            <td>Jan 15, 2025 10:30 AM</td>
                            <td><span class="badge badge-info">Created</span></td>
                            <td>John Doe</td>
                            <td>Journal entry created</td>
                        </tr>
                        <tr>
                            <td>Jan 15, 2025 10:35 AM</td>
                            <td><span class="badge badge-warning">Modified</span></td>
                            <td>John Doe</td>
                            <td>Updated description and amounts</td>
                        </tr>
                        <tr>
                            <td>Jan 15, 2025 2:15 PM</td>
                            <td><span class="badge badge-success">Posted</span></td>
                            <td>Jane Smith</td>
                            <td>Entry reviewed and posted to general ledger</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Related Transactions -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Related Information</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Source Document</h6>
                {% if entry.source_document %}
                    <p>{{ entry.source_document }}</p>
                {% else %}
                    <p class="text-muted">Invoice: INV-2025-001<br>
                    Customer: ABC Corporation<br>
                    Payment Method: Bank Transfer</p>
                {% endif %}
            </div>
            <div class="col-md-6">
                <h6>Entry Summary</h6>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Total Debit:</small><br>
                        <strong>${{ entry.total_debit|floatformat:2|default:"1,500.00" }}</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Total Credit:</small><br>
                        <strong>${{ entry.total_credit|floatformat:2|default:"1,500.00" }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Styles -->
<style>
@media print {
    .btn-toolbar, .card-header {
        display: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .card-body {
        padding: 0.5rem !important;
    }
    
    .table {
        font-size: 12px !important;
    }
    
    body {
        font-size: 12px !important;
    }
}

.badge-secondary {
    background-color: #6c757d !important;
}

.badge-success {
    background-color: #28a745 !important;
}

.badge-danger {
    background-color: #dc3545 !important;
}

.badge-info {
    background-color: #17a2b8 !important;
}

.badge-warning {
    background-color: #ffc107 !important;
    color: #212529 !important;
}

.table th {
    background-color: #f8f9fc;
    border-top: 1px solid #e3e6f0;
}
</style>
{% endblock %}
